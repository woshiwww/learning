### 学习操作系统

**学习操作系统需要的知识：**

- C语言
- 数据结构
- 算法
- 计算机体系结构

### 什么是操作系统

操作系统的组成：处理器、主存、磁盘、显示器···

操作系统的任务：管理设备、隐藏硬件

**操作系统管理的硬件资源：** CPU、内存（物理内存和虚拟内存）、磁盘、网卡驱动、声卡驱动、中断处理...

**操作系统：**操作系统处于硬件和应用程序之间。

- 向上：操作系统是一个控制软件，管理应用程序，为应用程序提供服务

- 向下：操作系统是一个资源管理器，管理外设分配资源。

  ![image-20220317205817558](https://gitee.com/one_to_one/markdown-img/raw/master/imgs/202203172058618.png)

操作系统有两个状态，分别是**内核态**和**用户态**。内核态具有对所有硬件的的完全访问权，此时可以执行机器能够运行的所有指令。用户态下只能只能使用指令的一个子集。操作系统将CPU抽象成了进程，磁盘抽象成了文件，内存抽象成了地址空间，以方便应用程序的使用。

![image-20220316154130274](https://gitee.com/one_to_one/markdown-img/raw/master/imgs/202203172052374.png)

Linux、Windows、Android的界面部分属于shell(也就是最熟悉的GUI，除此之外还包括一些命令行，shell是操作系统对外暴露的一些接口)，而不是内核，内核还在shell的下一层。shell是和用户交互的程序，命令行模式的叫shell，图形的叫GUI。

![image-20220316154832945](https://gitee.com/one_to_one/markdown-img/raw/master/imgs/202203172052568.png)

 

**操作系统内核的四个特征：**并发、共享、虚拟、异步。

1. 并发和并行：
   并发：在一段时间内有多个程序可以运行，分时复用一个CPU。

​				并行：在一个时间点上有多个程序可以同时进行，这通常要求具有多个CPU。

2. 共享：将资源有效的共享给不同的应用程序，比如“同时”访问内存、I/O，这个“同时”指的是在一个时间点上只有一个程序访问资源，是互斥共享的。
3. 虚拟：CPU-->进程，虚拟之后可以让每个用户都觉得有一个计算机专门为他服务，比如将一台物理计算机虚拟化成多台机器。
4. 异步：通过操作系统的管理和调度来可以跑多个程序。

异步和同步是相对而言的，通常会和阻塞、非阻塞同时记忆。

**同步，异步**，是**指两个线程之间的关系**，如果线程A对线程B发起请求，A要一直到等B的结果返回了才能继续往下运行，A和B就是同步关系。

如果线程A对线程B发起请求之后，不在原地等结果，直接干别的事情去了，等B有结果了再通知A，A和B的关系就是异步关系。

**阻塞，非阻塞**，是**指单个线程的状态**，如果线程A对线程B发起请求，A线程要等B线程的结果，A在等的过程中不干别的，线程挂起，休眠，就是阻塞状态；如果A线程不用等B的结果，直接干别的去了，那么就是非阻塞状态。如下：

老张爱喝茶，废话不说，煮开水。 出场人物：老张，水壶两把（普通水壶，简称水壶；会响的水壶，简称响水壶）。 

1 老张把水壶放到火上，立等水开。（同步阻塞） 老张觉得自己有点傻

 2 老张把水壶放到火上，去客厅看电视，时不时去厨房看看水开没有。（同步非阻塞） 老张还是觉得自己有点傻，于是变高端了，买了把会响笛的那种水壶。水开之后，能大声发出嘀~~~~的噪音。 

3 老张把响水壶放到火上，立等壶响。（异步阻塞） 老张觉得这样傻等意义不大 

4 老张把响水壶放到火上，去客厅看电视，水壶响之前不再去看它了，响了再去拿壶。（异步非阻塞） 老张觉得自己聪明了。

所谓同步异步，只是对于水壶而言。 普通水壶，同步；响水壶，异步。 虽然都能干活，但响水壶可以在自己完工之后，提示老张水开了。这是普通水壶所不能及的。 同步只能让调用者去轮询自己（情况2中），造成老张效率的低下。

所谓阻塞非阻塞，仅仅对于老张而言。 立等的老张，阻塞；看电视的老张，非阻塞。 情况1和情况3中老张就是阻塞的，媳妇喊他都不知道。虽然3中响水壶是异步的，可对于立等的老张没有太大的意义。所以一般异步是配合非阻塞使用的，这样才能发挥异步的效用。

### 启动、中断、异常和系统调用

#### 启动

**计算机体系结构概述**

计算机最基本的结构是CPU、内存、和硬盘。

![image-20220316204901514](https://gitee.com/one_to_one/markdown-img/raw/master/imgs/202203162049585.png)

**开机顺序**

操作系统一开始是存放在硬盘上的，由Bootloader来将操作系统放到内存上。然后用BIOS（基本I/O处理系统）来提供相应的支持，它能让计算机在开机之后让计算机系统检测各种各样的外设，加载相应的软件来进行执行。如下图所示，在内存上有一部分空间由BIOS事先占据了，然后将Bootloader加载到内存上的特定的位置，最后又Bootloader将操作系统的代码和数据加载到内存中。CPU的控制权先交给Bootloader，再交给操作系统。

![image-20220316205527796](https://gitee.com/one_to_one/markdown-img/raw/master/imgs/202203172052314.png)

#### 系统调用、异常、中断

面向外设：用系统调用和I/O来处理的

面向应用程序：系统调用和异常来提供相应的功能

系统调用(来源于应用程序)：应用程序主动向操作系统发出服务请求，希望操作系统提供相应的支持。

异常(来源于不良的应用程序)：非法指令和其他一些坏的处理状态，不是应用程序主动产生的，是应用程序在执行的过程中出现了一些意想不到的事情，如内存出错。

中断(来源于外设)：来自不同的硬件设备的计时器和网络的中断。

*应用程序是不能直接访问外设的，必须通过操作系统这个第三方。*

**中断、异常和系统调用三者的特征和差别**

产生的源头：

- 中断：外设
- 异常：应用程序意想不到的行为
- 系统调用：应用程序请求操作系统提供服务 

处理时间：

- 中断：中断一般成称为异步事件，既不知道什么时候产生的事件。
- 异常：同步事件，执行到特定的指令一定会产生异常，比如除以0
- 系统调用：异步或同步，一个程序发出请求之后，如果等待操作系统的反馈就是同步的，如果去执行别的任务就是异步的。

相应状态：

- 中断：会打断当前应用程序的正常执行，但应用程序在运行过程中感受不到中断的产生。
- 异常：把产生异常的应用程序杀死，或者重新执行该程序。
- 系统调用：等待服务完成之后继续执行。    

### 资源管理

资源管理有两种不同的方式来实现多路复用资源  ：

- **时间上复用：**不同的程序轮流使用。比如某个系统只有一个CPU，需要在上面运行多个程序，每个程序在不同的时间点使用CPU，需要等待才能使用CPU。
- **空间上复用：**每个客户都会得到资源的一部分，取代了排队现象。比如正在运行的程序会分割内存，这样每一个程序都会放到内存上，比把所有内存给一个程序效率要高的多。还有在多用户的系统中，一个磁盘要为多个用户存储文件，要分配磁盘空间并记录是谁正在使用哪块磁盘。